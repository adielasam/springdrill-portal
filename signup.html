<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SPRINGDRILL - Signup</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.5)), url('tech3.jpg'); background-size: cover; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .signup-container { background: white; padding: 2.5rem; border-radius: 20px; width: 100%; max-width: 450px; }
    </style>
</head>
<body>
    <div class="signup-container">
        <h2 class="text-center mb-4">Create Account</h2>
        <div id="alertBox" class="alert d-none"></div>
        <form id="signupForm">
            <div class="mb-3"><label>Full Name</label><input type="text" id="name" class="form-control" required></div>
            <div class="mb-3"><label>Email</label><input type="email" id="email" class="form-control" required></div>
            <div class="mb-3"><label>Password</label><input type="password" id="password" class="form-control" required minlength="6"></div>
            <div class="mb-3">
                <label>Role</label>
                <select id="role" class="form-select" required>
                    <option value="student">Student</option>
                    <option value="teacher">Teacher</option>
                </select>
            </div>
            <div class="mb-3" id="class-div"><label>Class</label><select id="class_id" class="form-select"></select></div>
            <button type="submit" class="btn btn-success w-100" id="submitBtn">Sign Up</button>
        </form>
    </div>
    <script type="module">
        import { supabase } from './supabaseClient.js';
        const roleSel = document.getElementById('role');
        roleSel.onchange = () => document.getElementById('class-div').style.display = roleSel.value === 'student' ? 'block' : 'none';
        
        async function loadClasses() {
            const { data } = await supabase.from('classes').select('*');
            document.getElementById('class_id').innerHTML = data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
        loadClasses();

        document.getElementById('signupForm').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { data, error } = await supabase.auth.signUp({ email, password });
            if (error) alert(error.message);
            else {
                const userId = data.user.id;
                await supabase.from('users').insert([{ id: userId, email, name: document.getElementById('name').value, role: roleSel.value, username: email.split('@')[0] }]);
                if (roleSel.value === 'student') await supabase.from('students').insert([{ user_id: userId, class_id: document.getElementById('class_id').value, approved: false }]);
                else await supabase.from('teachers').insert([{ user_id: userId, approved: false }]);
                alert('Account created! Awaiting admin approval.');
            }
        };
    </script>
</body>
</html>