<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPRINGDRILL - User Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f4f7fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .content { padding: 30px; max-width: 1000px; margin: 0 auto; }
        .header { background: linear-gradient(90deg, #1a3c34, #2c5f4a); color: white; padding: 20px 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); padding: 25px; background: white; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.85em; font-weight: bold; }
        .status-pending { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .status-approved { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .nav-pills .nav-link { border-radius: 50px; margin-right: 10px; color: #1a3c34; border: 1px solid #1a3c34; }
        .nav-pills .nav-link.active { background-color: #1a3c34; color: white; }
        .table th { border-top: none; color: #6c757d; font-weight: 600; text-transform: uppercase; font-size: 0.85rem; }
        .table td { vertical-align: middle; }
    </style>
</head>
<body>
    <div class="content">
        <div class="header">
            <h2 class="m-0"><i class="fas fa-users-cog me-2"></i> Approval Queue</h2>
            <a href="admin_dashboard.html" class="btn btn-outline-light"><i class="fas fa-arrow-left me-1"></i> Back to Dashboard</a>
        </div>

        <div class="card">
            <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pills-teachers-tab" data-bs-toggle="pill" data-bs-target="#pills-teachers" type="button" role="tab">
                        <i class="fas fa-chalkboard-teacher me-1"></i> Teachers
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-students-tab" data-bs-toggle="pill" data-bs-target="#pills-students" type="button" role="tab">
                        <i class="fas fa-user-graduate me-1"></i> Students
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="pills-teachers" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr><th>Name</th><th>Email</th><th>Status</th><th>Action</th></tr>
                            </thead>
                            <tbody id="teachersTbody">
                                <tr><td colspan="4" class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading teachers...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="pills-students" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr><th>Name</th><th>Class</th><th>Status</th><th>Action</th></tr>
                            </thead>
                            <tbody id="studentsTbody">
                                <tr><td colspan="4" class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading students...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { supabase } from './supabaseClient.js';

        async function loadUsers() {
            try {
                // Fetch Teachers
                const { data: teachers, error: tError } = await supabase
                    .from('teachers')
                    .select('id, approved, users!inner(name, email)')
                    .order('approved', { ascending: true }); // Show pending first
                
                if (tError) throw tError;

                const tBody = document.getElementById('teachersTbody');
                if (teachers.length === 0) {
                    tBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No teachers found.</td></tr>';
                } else {
                    tBody.innerHTML = teachers.map(t => `
                        <tr>
                            <td class="fw-bold text-dark">${t.users.name}</td>
                            <td class="text-muted">${t.users.email}</td>
                            <td><span class="status-badge ${t.approved ? 'status-approved' : 'status-pending'}">${t.approved ? 'Approved' : 'Pending'}</span></td>
                            <td>
                                ${!t.approved 
                                    ? `<button onclick="window.approveUser('teachers', ${t.id})" class="btn btn-sm btn-success"><i class="fas fa-check me-1"></i> Approve</button>` 
                                    : `<button disabled class="btn btn-sm btn-secondary"><i class="fas fa-check-double me-1"></i> Done</button>`}
                            </td>
                        </tr>
                    `).join('');
                }

                // Fetch Students
                const { data: students, error: sError } = await supabase
                    .from('students')
                    .select('id, approved, classes(name), users!inner(name)')
                    .order('approved', { ascending: true }); // Show pending first
                
                if (sError) throw sError;

                const sBody = document.getElementById('studentsTbody');
                if (students.length === 0) {
                    sBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No students found.</td></tr>';
                } else {
                    sBody.innerHTML = students.map(s => `
                        <tr>
                            <td class="fw-bold text-dark">${s.users.name}</td>
                            <td class="text-muted">${s.classes?.name || 'Unassigned'}</td>
                            <td><span class="status-badge ${s.approved ? 'status-approved' : 'status-pending'}">${s.approved ? 'Approved' : 'Pending'}</span></td>
                            <td>
                                ${!s.approved 
                                    ? `<button onclick="window.approveUser('students', ${s.id})" class="btn btn-sm btn-success"><i class="fas fa-check me-1"></i> Approve</button>` 
                                    : `<button disabled class="btn btn-sm btn-secondary"><i class="fas fa-check-double me-1"></i> Done</button>`}
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error("Error loading users:", error);
                alert("Failed to load users. Please check your connection.");
            }
        }

        // Make function globally available to inline onclick handlers
        window.approveUser = async (table, id) => {
            const { error } = await supabase.from(table).update({ approved: true }).eq('id', id);
            if (error) {
                alert("Error approving user: " + error.message);
            } else {
                loadUsers(); // Refresh tables instantly
            }
        };

        document.addEventListener('DOMContentLoaded', loadUsers);
    </script>
</body>
</html>