<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPRINGDRILL - Test Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7fa; }
        .content { padding: 20px; max-width: 1000px; margin: 0 auto; }
        .profile-header { background-color: #1a3c34; color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .summary-card { background-color: #ffffff; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-top: 4px solid #3498db; }
        .result-card { background-color: #ffffff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 15px; border-left: 5px solid #2ecc71; transition: transform 0.2s; }
        .result-card:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
        .score-badge { font-size: 1.5em; font-weight: bold; }
        .accordion-button { background-color: #f8f9fa; font-weight: 500; }
        .accordion-button:not(.collapsed) { background-color: #e3f2fd; color: #0d6efd; box-shadow: none; }
    </style>
</head>
<body>
    <div class="content">
        <div class="profile-header">
            <div>
                <h2 class="mb-0"><i class="fas fa-user-graduate me-2"></i> <span id="studentName">Loading...</span>'s Results</h2>
            </div>
            <a href="student_dashboard.html" class="btn btn-outline-light"><i class="fas fa-arrow-left me-1"></i> Dashboard</a>
        </div>

        <div id="alertBox" class="alert d-none"></div>

        <div class="summary-card" id="summaryCard" style="display: none;">
            <h4 class="mb-3 text-primary"><i class="fas fa-chart-line me-2"></i> Performance Summary</h4>
            <div class="row text-center">
                <div class="col-6">
                    <p class="text-muted mb-1">Total Tests Taken</p>
                    <h3 id="totalTests">0</h3>
                </div>
                <div class="col-6">
                    <p class="text-muted mb-1">Average Score</p>
                    <h3 id="averageScore" class="text-success">0.00%</h3>
                </div>
            </div>
        </div>

        <div id="resultsContainer">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Fetching your results...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        import { supabase } from './supabaseClient.js';

        const alertBox = document.getElementById('alertBox');
        function showAlert(msg) {
            alertBox.className = 'alert alert-danger d-block';
            alertBox.textContent = msg;
        }

        async function loadResults() {
            try {
                // 1. Authenticate Current User
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                if (authError || !user) {
                    window.location.href = 'login.html';
                    return;
                }

                // 2. Fetch User Profile
                const { data: profile } = await supabase.from('users').select('name').eq('id', user.id).single();
                document.getElementById('studentName').textContent = profile?.name || 'Student';

                // 3. Fetch Test Results with Nested Joins
                // This replaces the complex PHP JOIN query with a single, deeply relational Supabase fetch
                const { data: results, error: resultsError } = await supabase
                    .from('test_results')
                    .select(`
                        score, percentage, medical_info, remarks, result_analysis, admin_approved,
                        tests (
                            id, title,
                            classes (name),
                            subjects (name),
                            sessions (name)
                        )
                    `)
                    .eq('student_id', user.id)
                    .order('created_at', { ascending: false });

                if (resultsError) throw resultsError;

                const container = document.getElementById('resultsContainer');

                // Handle Empty State
                if (!results || results.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5 bg-white rounded shadow-sm">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <h5>No Results Found</h5>
                            <p class="text-muted">You have not taken any tests yet.</p>
                            <a href="cbt_manager.html" class="btn btn-primary mt-2">Take a Test Now</a>
                        </div>`;
                    document.getElementById('summaryCard').style.display = 'block';
                    return;
                }

                // Calculate Summary Statistics
                let totalPercentage = 0;
                results.forEach(r => totalPercentage += parseFloat(r.percentage || 0));
                const avg = (totalPercentage / results.length).toFixed(2);

                document.getElementById('totalTests').textContent = results.length;
                document.getElementById('averageScore').textContent = `${avg}%`;
                document.getElementById('summaryCard').style.display = 'block';

                // Render Result Cards
                let html = '<div class="row">';
                results.forEach(r => {
                    const t = r.tests;
                    const testId = t.id;
                    const isApproved = r.admin_approved;
                    const statusBadge = isApproved 
                        ? '<span class="badge bg-success"><i class="fas fa-check-circle"></i> Approved by Admin</span>' 
                        : '<span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Pending Approval</span>';

                    html += `
                        <div class="col-md-12">
                            <div class="result-card">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h5 class="mb-1 text-primary">${t.title}</h5>
                                        ${statusBadge}
                                    </div>
                                    <div class="text-end">
                                        <span class="text-muted d-block" style="font-size: 0.85em;">Final Score</span>
                                        <span class="score-badge text-success">${parseFloat(r.percentage || 0).toFixed(1)}%</span>
                                    </div>
                                </div>
                                
                                <div class="row mb-3 text-muted" style="font-size: 0.9em;">
                                    <div class="col-sm-4"><i class="fas fa-users me-1"></i> <strong>Class:</strong> ${t.classes?.name || 'N/A'}</div>
                                    <div class="col-sm-4"><i class="fas fa-book me-1"></i> <strong>Subject:</strong> ${t.subjects?.name || 'N/A'}</div>
                                    <div class="col-sm-4"><i class="fas fa-calendar me-1"></i> <strong>Session:</strong> ${t.sessions?.name || 'N/A'}</div>
                                </div>

                                <div class="accordion" id="accordion_${testId}">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMed_${testId}">
                                                <i class="fas fa-notes-medical me-2 text-danger"></i> Medical Information
                                            </button>
                                        </h2>
                                        <div id="collapseMed_${testId}" class="accordion-collapse collapse" data-bs-parent="#accordion_${testId}">
                                            <div class="accordion-body bg-light">
                                                ${r.medical_info ? r.medical_info : '<em>No medical information provided.</em>'}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRem_${testId}">
                                                <i class="fas fa-comment-dots me-2 text-info"></i> Teacher Remarks
                                            </button>
                                        </h2>
                                        <div id="collapseRem_${testId}" class="accordion-collapse collapse" data-bs-parent="#accordion_${testId}">
                                            <div class="accordion-body bg-light">
                                                ${r.remarks ? r.remarks : '<em>No remarks provided.</em>'}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAna_${testId}">
                                                <i class="fas fa-microscope me-2 text-primary"></i> Result Analysis
                                            </button>
                                        </h2>
                                        <div id="collapseAna_${testId}" class="accordion-collapse collapse" data-bs-parent="#accordion_${testId}">
                                            <div class="accordion-body bg-light">
                                                ${r.result_analysis ? r.result_analysis : '<em>No analysis provided.</em>'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                });
                html += '</div>';
                container.innerHTML = html;

            } catch (err) {
                showAlert("System error: Unable to load results.");
                console.error(err);
            }
        }

        document.addEventListener('DOMContentLoaded', loadResults);
    </script>
</body>
</html>