<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPRINGDRILL - Manage CBT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-x: hidden; }
        
        /* Sidebar Styling */
        .sidebar { width: 260px; position: fixed; top: 0; left: 0; height: 100vh; background: #1a3c34; color: white; padding-top: 30px; z-index: 1000; }
        .sidebar-brand { text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .nav-link { color: rgba(255,255,255,0.8); padding: 12px 20px; margin: 2px 10px; border-radius: 5px; transition: all 0.3s; display: flex; align-items: center; font-size: 0.95rem; }
        .nav-link i { width: 25px; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.15); color: white; }
        
        /* Main Content */
        .main-content { margin-left: 260px; padding: 20px 40px; min-height: 100vh; }
        
        /* Cards */
        .edu-card { background: white; border: 1px solid #dee2e6; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); margin-bottom: 30px; }
        .edu-header { background-color: #007a4d; color: white; padding: 12px 20px; border-radius: 4px 4px 0 0; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .edu-body { padding: 25px; }

        /* Table Styling */
        .table th { border-top: none; color: #495057; font-weight: bold; text-transform: uppercase; font-size: 0.8rem; background-color: #f8f9fa; }
        .table td { vertical-align: middle; font-size: 0.9rem; }
        
        .badge-draft { background-color: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; border: 1px solid #ffeeba;}
        .badge-live { background-color: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; border: 1px solid #c3e6cb;}

        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <i class="fas fa-spinner fa-spin fa-3x text-success mb-3"></i>
        <h4>Loading Test Manager...</h4>
    </div>

    <div class="sidebar">
        <div class="sidebar-brand">
            <h5 class="text-white fw-bold mb-0"><i class="fas fa-graduation-cap text-warning me-2"></i> SPRINGDRILL</h5>
        </div>
        
        <nav class="nav flex-column mt-3">
            <a href="teacher_dashboard.html" class="nav-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            
            <a href="#cbtMenu" data-bs-toggle="collapse" class="nav-link d-flex justify-content-between align-items-center mt-2 bg-success text-white">
                <span><i class="fas fa-laptop-code me-2"></i> CBT</span>
                <i class="fas fa-caret-down"></i>
            </a>
            <div class="collapse show bg-dark mx-2 mt-1 rounded" id="cbtMenu">
                <a href="#" class="nav-link small py-2 text-muted"><i class="fas fa-database me-2"></i> Question Bank</a>
                <a href="manage_cbt.html" class="nav-link small py-2 active text-success fw-bold"><i class="fas fa-list me-2"></i> Manage CBT</a>
                <a href="test_results.html" class="nav-link small py-2"><i class="fas fa-chart-bar me-2"></i> Result Manager</a>
            </div>

            <hr class="mx-3 my-4 border-secondary">
            <a href="#" id="logoutBtn" class="nav-link text-danger mt-auto"><i class="fas fa-power-off"></i> Logout</a>
        </nav>
    </div>

    <div class="main-content">
        <h5 class="text-muted fw-bold mb-4">Home / Cbt / Manage CBT</h5>

        <div class="edu-card">
            <div class="edu-header">
                <span><i class="fas fa-filter me-2"></i> Test Manager</span>
            </div>
            <div class="edu-body py-3">
                <div class="row g-3 align-items-center">
                    <div class="col-md-5 d-flex align-items-center">
                        <label class="form-label me-3 fw-bold mb-0 text-muted" style="min-width: 80px;">Class</label>
                        <select class="form-select form-select-sm border-dark" id="filterClass">
                            <option value="">All Classes</option>
                        </select>
                    </div>
                    <div class="col-md-5 d-flex align-items-center">
                        <label class="form-label me-3 fw-bold mb-0 text-muted" style="min-width: 80px;">Subject</label>
                        <select class="form-select form-select-sm border-dark" id="filterSubject">
                            <option value="">All Subjects</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-sm btn-dark w-100 fw-bold" onclick="window.loadTestList()">Apply Filter</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="edu-card">
            <div class="edu-header">
                <span><i class="fas fa-list-ul me-2"></i> Test List</span>
                <a href="create_test.html" class="btn btn-sm btn-light text-success fw-bold px-3 shadow-sm"><i class="fas fa-plus me-1"></i> New Test</a>
            </div>
            <div class="edu-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light border-bottom">
                            <tr>
                                <th class="text-center" width="5%">S/N</th>
                                <th width="65%">Test Information</th>
                                <th width="30%" class="text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="testListBody">
                            <tr><td colspan="3" class="text-center py-5"><i class="fas fa-spinner fa-spin me-2"></i> Fetching records...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { supabase } from './supabaseClient.js';

        let currentUserId = null;
        let currentUserProfile = null;

        // 1. Initialize Page and Populate Dropdowns
        window.initializePage = async function() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return window.location.href = 'login.html';
                currentUserId = session.user.id;

                const { data: profile } = await supabase.from('users').select('name').eq('id', currentUserId).single();
                currentUserProfile = profile;

                // Populate Class Dropdown
                const { data: classes } = await supabase.from('classes').select('id, name').order('id');
                const classSelect = document.getElementById('filterClass');
                if (classes) {
                    classes.forEach(c => {
                        classSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                    });
                }

                // Populate Subject Dropdown
                const { data: subjects } = await supabase.from('subjects').select('id, name').order('name');
                const subjectSelect = document.getElementById('filterSubject');
                if (subjects) {
                    subjects.forEach(s => {
                        subjectSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                    });
                }

                // Load initial table data
                await window.loadTestList();

            } catch (err) {
                console.error(err);
                alert("Failed to initialize manager.");
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        };

        // 2. Fetch and Render the Table (WITH FILTERS)
        window.loadTestList = async function() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            try {
                const classFilterId = document.getElementById('filterClass').value;
                const subjectFilterId = document.getElementById('filterSubject').value;

                // Build the Query Dynamically
                let query = supabase
                    .from('tests')
                    .select('*, classes(name), subjects(name)')
                    .eq('teacher_id', currentUserId)
                    .order('created_at', { ascending: false });

                // Apply filters if the user selected something
                if (classFilterId) {
                    query = query.eq('class_id', classFilterId);
                }
                if (subjectFilterId) {
                    query = query.eq('subject_id', subjectFilterId);
                }

                const { data: tests, error } = await query;
                if (error) throw error;

                // Compute Total Questions & Marks per test
                const { data: testQuestions } = await supabase.from('test_questions').select('test_id, questions(marks)');
                const stats = {};
                if (testQuestions) {
                    testQuestions.forEach(tq => {
                        if (!stats[tq.test_id]) stats[tq.test_id] = { count: 0, marks: 0 };
                        stats[tq.test_id].count += 1;
                        stats[tq.test_id].marks += (tq.questions?.marks || 1);
                    });
                }

                // Render Table
                const tbody = document.getElementById('testListBody');
                if (!tests || tests.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="3" class="text-center py-5 text-muted">No tests found matching your criteria.</td></tr>`;
                } else {
                    tbody.innerHTML = tests.map((test, index) => {
                        const tStats = stats[test.id] || { count: 0, marks: 0 };
                        const statusBadge = test.is_published 
                            ? `<span class="badge-live"><i class="fas fa-globe me-1"></i> Published</span>` 
                            : `<span class="badge-draft"><i class="fas fa-lock me-1"></i> Not Published</span>`;
                        
                        const scheduleText = test.start_time 
                            ? `<div class="small text-muted text-end mt-1"><i class="fas fa-calendar-alt me-1"></i> Opens: ${new Date(test.start_time).toLocaleString()}</div>`
                            : `<div class="small text-muted text-end mt-1"><i class="fas fa-bolt text-warning me-1"></i> Instantly Live upon Publish</div>`;

                        return `
                            <tr>
                                <td class="text-center fw-bold text-muted">${index + 1}</td>
                                <td>
                                    <div class="mb-1">
                                        <strong class="text-success" style="font-size: 1.05rem; text-transform: uppercase;">${test.title}</strong> 
                                        <span class="text-muted ms-1 fw-bold">(${test.classes?.name || 'Unassigned'} - ${test.subjects?.name || 'Subject'})</span>
                                    </div>
                                    <div class="small text-muted mb-2">
                                        <span class="me-3"><i class="fas fa-clock text-dark"></i> ${test.duration_minutes || test.duration || 30} mins</span>
                                        <span class="me-3"><i class="fas fa-question-circle text-primary"></i> Qty: <strong>${tStats.count}</strong></span>
                                        <span><i class="fas fa-star text-warning"></i> Marks: <strong>${tStats.marks}</strong></span>
                                    </div>
                                    <div>${statusBadge}</div>
                                </td>
                                <td class="text-end pe-4 align-middle">
                                    <div class="btn-group shadow-sm">
                                        <button class="btn btn-sm ${test.is_published ? 'btn-outline-warning' : 'btn-outline-success'} fw-bold" onclick="window.togglePublish(${test.id}, ${test.is_published}, ${tStats.count})">
                                            <i class="fas ${test.is_published ? 'fa-lock' : 'fa-globe'}"></i> ${test.is_published ? 'Unpublish' : 'Publish'}
                                        </button>
                                        <a href="assign_questions.html?test_id=${test.id}" class="btn btn-sm btn-info text-white fw-bold">
                                            <i class="fas fa-edit"></i> Edit Qs
                                        </a>
                                        <button class="btn btn-sm btn-danger fw-bold" onclick="window.deleteTest(${test.id})">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                    ${scheduleText}
                                </td>
                            </tr>
                        `;
                    }).join('');
                }

                document.getElementById('loadingOverlay').style.display = 'none';
            } catch (err) {
                console.error(err);
                alert("Failed to load test list.");
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        };

        // Initialize immediately upon script load
        document.addEventListener('DOMContentLoaded', window.initializePage);

        // Publish Toggle with Security Lock
        window.togglePublish = async (testId, currentStatus, questionCount) => {
            const newStatus = !currentStatus;
            
            if (newStatus === true && questionCount === 0) {
                alert("ACTION BLOCKED: You cannot publish an empty test. Please click 'Edit Qs' to add questions first.");
                return;
            }

            if (!confirm(newStatus ? "Publish this test to the Student Dashboard?" : "Hide this test from students?")) return;

            try {
                document.getElementById('loadingOverlay').style.display = 'flex';
                const { error } = await supabase.from('tests').update({ is_published: newStatus }).eq('id', testId);
                if (error) throw error;
                window.loadTestList(); // Refresh table
            } catch (err) {
                alert("Error: " + err.message);
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        };

        // Delete Test
        window.deleteTest = async (testId) => {
            if (!confirm("WARNING: Are you sure you want to completely delete this test and all its questions?")) return;
            try {
                document.getElementById('loadingOverlay').style.display = 'flex';
                await supabase.from('test_results').delete().eq('test_id', testId);
                await supabase.from('test_questions').delete().eq('test_id', testId);
                await supabase.from('tests').delete().eq('id', testId);
                window.loadTestList(); // Refresh table
            } catch (err) {
                alert("Error deleting test.");
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        };

        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault(); await supabase.auth.signOut(); window.location.href = 'login.html';
        });
    </script>
</body>
</html>