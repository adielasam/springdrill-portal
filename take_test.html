<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPRINGDRILL - CBT Examination</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-x: hidden; }
        
        /* Header & Timer */
        .top-bar { background: linear-gradient(180deg, #1a3c34 0%, #122b25 100%); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .timer-box { background: rgba(255,255,255,0.1); padding: 8px 20px; border-radius: 8px; font-weight: bold; font-family: monospace; font-size: 1.4rem; border: 1px solid rgba(255,255,255,0.2); }
        .timer-warning { background: rgba(220, 53, 69, 0.2); border-color: #dc3545; color: #ffcccc; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        /* Exam Container */
        .exam-container { max-width: 850px; margin: 40px auto; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 40px; }
        .question-number { color: #f1c40f; font-weight: bold; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; display: block; border-bottom: 2px solid #f4f7fa; padding-bottom: 10px;}
        .question-text { font-size: 1.35rem; color: #2c3e50; font-weight: 600; margin-bottom: 35px; line-height: 1.6; }
        
        /* Options */
        .option-label { display: block; padding: 15px 20px; border: 2px solid #e9ecef; border-radius: 10px; margin-bottom: 15px; cursor: pointer; transition: all 0.2s; font-size: 1.1rem; color: #495057; background: white;}
        .option-label:hover { border-color: #1a3c34; background: #f8f9fa; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.02);}
        .option-input:checked + .option-label { border-color: #1a3c34; background: #e8f5e9; color: #1a3c34; font-weight: bold; box-shadow: 0 0 0 3px rgba(26,60,52,0.1); }
        .option-input { display: none; }

        /* Navigation */
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 40px; border-top: 2px solid #e9ecef; padding-top: 25px; }
        
        /* Overlays */
        #loadingOverlay, #fallbackOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f7fa; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        #fallbackOverlay { display: none; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <i class="fas fa-spinner fa-spin fa-3x text-warning mb-3"></i>
        <h4 class="text-dark fw-bold">Verifying Student Profile & Exam Records...</h4>
    </div>

    <div id="fallbackOverlay">
        <div style="background: white; padding: 40px 30px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 450px;">
            <i class="fas fa-file-signature fa-4x text-warning mb-3"></i>
            <h3 style="font-weight: bold; color: #1a3c34; margin-bottom: 10px;">No Exam Selected</h3>
            <p style="color: #6c757d; margin-bottom: 25px; font-size: 0.95rem;">You have not selected a specific test to take. Please return to your Student Dashboard to view and select from your currently active assigned tests.</p>
            <a href="student_dashboard.html" class="btn btn-dark w-100 fw-bold py-2"><i class="fas fa-arrow-left me-2"></i> Return to Dashboard</a>
        </div>
    </div>

    <div class="top-bar" id="examHeader" style="display: none;">
        <div>
            <h4 class="mb-0 fw-bold text-warning" id="displayTestTitle">Loading Exam...</h4>
            <small class="opacity-75" id="displayStudentName"><i class="fas fa-user-graduate me-1"></i> Student Candidate</small>
        </div>
        <div class="timer-box" id="timerDisplay">
            <i class="fas fa-clock me-2"></i>--:--
        </div>
    </div>

    <div class="exam-container" id="examContent" style="display: none;">
        
        <div id="questionArea">
            <span class="question-number" id="questionCounter">Question 1 of --</span>
            <div class="question-text" id="questionText">Loading question...</div>
            
            <div class="options-container" id="optionsContainer">
                </div>
        </div>

        <div class="nav-buttons">
            <button class="btn btn-outline-secondary fw-bold px-4" id="prevBtn" onclick="navigate(-1)" disabled><i class="fas fa-chevron-left me-2"></i> Previous</button>
            <button class="btn btn-dark fw-bold px-4" id="nextBtn" onclick="navigate(1)">Next <i class="fas fa-chevron-right ms-2"></i></button>
            <button class="btn btn-success fw-bold px-5 shadow-sm" id="submitBtn" style="display: none;" onclick="submitExam()"><i class="fas fa-check-double me-2"></i> Submit Exam</button>
        </div>
    </div>

    <script type="module">
        import { supabase } from './supabaseClient.js';

        let studentSession = null;
        let testId = null;
        let testData = null;
        let questions = [];
        let currentIdx = 0;
        let userAnswers = {}; // Stores chosen options e.g. { 'question_id': 'A' }
        let timerInterval;
        let timeRemaining = 0;

        async function initializeExam() {
            try {
                // 1. Authenticate Student
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return window.location.href = 'login.html';
                studentSession = session;

                // Grab student name for header
                const { data: stuData } = await supabase.from('students').select('surname, first_name, users(name)').eq('user_id', session.user.id).single();
                if (stuData) {
                    const name = stuData.surname ? `${stuData.first_name} ${stuData.surname}` : stuData.users.name;
                    document.getElementById('displayStudentName').innerHTML = `<i class="fas fa-user-graduate me-1"></i> ${name}`;
                }

                // 2. Check for Test ID in URL
                const urlParams = new URLSearchParams(window.location.search);
                testId = urlParams.get('id') || urlParams.get('test_id');

                // If no ID is found, trigger the friendly UI instead of crashing!
                if (!testId) {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('fallbackOverlay').style.display = 'flex';
                    return; 
                }

                // 3. Prevent retakes
                const { data: pastAttempt } = await supabase.from('test_results').select('id').eq('student_id', session.user.id).eq('test_id', testId).single();
                if (pastAttempt) {
                    alert("You have already submitted this exam. Returning to dashboard.");
                    return window.location.href = 'student_dashboard.html';
                }

                // 4. Fetch the Test and Questions
                const { data: tData, error: tErr } = await supabase.from('tests').select('*').eq('id', testId).single();
                if (tErr) throw new Error("Exam details not found.");
                testData = tData;

                const { data: qData, error: qErr } = await supabase.from('questions').select('*').eq('test_id', testId).order('id');
                if (qErr || !qData || qData.length === 0) throw new Error("No questions available for this exam.");
                
                questions = qData;
                document.getElementById('displayTestTitle').innerText = testData.title || 'CBT Examination';

                // 5. Start the Timer (assumes testData.duration is in minutes)
                timeRemaining = (testData.duration || 30) * 60; 
                startTimer();

                // 6. Reveal the Exam interface
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('examHeader').style.display = 'flex';
                document.getElementById('examContent').style.display = 'block';
                
                renderQuestion();

            } catch (err) {
                console.error(err);
                alert(err.message || "An error occurred loading the exam.");
                window.location.href = 'student_dashboard.html';
            }
        }

        // Render Question Function
        window.renderQuestion = () => {
            const q = questions[currentIdx];
            document.getElementById('questionCounter').innerText = `Question ${currentIdx + 1} of ${questions.length}`;
            document.getElementById('questionText').innerText = q.question_text || q.question;

            const savedAns = userAnswers[q.id];

            // Renders Options A, B, C, D dynamically
            const optionsHtml = ['a', 'b', 'c', 'd'].map(opt => {
                const optValue = q[`option_${opt}`] || q[opt]; 
                if (!optValue) return ''; 
                
                const isChecked = savedAns === opt.toUpperCase() ? 'checked' : '';
                
                return `
                    <label>
                        <input type="radio" name="examOption" class="option-input" value="${opt.toUpperCase()}" ${isChecked} onchange="saveAnswer('${q.id}', this.value)">
                        <div class="option-label"><strong class="me-3">${opt.toUpperCase()}.</strong> ${optValue}</div>
                    </label>
                `;
            }).join('');

            document.getElementById('optionsContainer').innerHTML = optionsHtml;

            // Handle Button Display
            document.getElementById('prevBtn').disabled = currentIdx === 0;
            if (currentIdx === questions.length - 1) {
                document.getElementById('nextBtn').style.display = 'none';
                document.getElementById('submitBtn').style.display = 'block';
            } else {
                document.getElementById('nextBtn').style.display = 'block';
                document.getElementById('submitBtn').style.display = 'none';
            }
        };

        // Temporary save
        window.saveAnswer = (qId, value) => {
            userAnswers[qId] = value;
        };

        // Next/Prev Navigation
        window.navigate = (direction) => {
            currentIdx += direction;
            renderQuestion();
        };

        // Timer Function
        function startTimer() {
            const display = document.getElementById('timerDisplay');
            timerInterval = setInterval(() => {
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    display.innerHTML = `<i class="fas fa-clock me-2"></i>Time's Up!`;
                    alert("Time is up! Your exam will now be submitted automatically.");
                    submitExam();
                    return;
                }

                timeRemaining--;
                const m = Math.floor(timeRemaining / 60).toString().padStart(2, '0');
                const s = (timeRemaining % 60).toString().padStart(2, '0');
                display.innerHTML = `<i class="fas fa-clock me-2"></i>${m}:${s}`;

                // Add red warning pulse if less than 5 mins remain
                if (timeRemaining < 300) display.classList.add('timer-warning');
            }, 1000);
        }

        // Grading and Submission
        window.submitExam = async () => {
            clearInterval(timerInterval);
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Grading & Submitting...';
            btn.disabled = true;

            try {
                // 1. Calculate Score
                let score = 0;
                questions.forEach(q => {
                    const correctAns = q.correct_option || q.answer; 
                    if (userAnswers[q.id] === correctAns) {
                        score++;
                    }
                });

                // 2. Save Results to Database
                const { error } = await supabase.from('test_results').insert([{
                    student_id: studentSession.user.id,
                    test_id: testId,
                    score: score,
                    total_questions: questions.length
                }]);

                if (error) throw error;

                // 3. Success Feedback
                alert(`Exam submitted successfully! You scored ${score} out of ${questions.length}.`);
                window.location.href = 'student_dashboard.html';

            } catch (err) {
                console.error(err);
                alert("Error submitting exam: " + err.message);
                btn.innerHTML = '<i class="fas fa-check-double me-2"></i> Submit Exam';
                btn.disabled = false;
                startTimer(); // resume timer in case of network drop
            }
        };

        // Fire it up!
        document.addEventListener('DOMContentLoaded', initializeExam);
    </script>
</body>
</html>