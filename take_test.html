<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPRINGDRILL - Taking Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-x: hidden; }
        
        /* Top Header */
        .exam-header { background: white; padding: 15px 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #007a4d;}
        .school-logo { display: flex; align-items: center; font-weight: bold; font-size: 1.2rem; color: #007a4d;}
        .exam-info { text-align: right; font-size: 0.85rem; font-weight: bold; color: #495057; line-height: 1.6;}
        .exam-info span { color: #d9534f; }

        .main-container { max-width: 900px; margin: 30px auto; background: white; padding: 30px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        /* Navigation Grid */
        .subject-badge { background: #5bc0de; color: white; padding: 5px 15px; border-radius: 4px; font-weight: bold; display: inline-block; margin-bottom: 15px; }
        .q-grid { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 20px; }
        .q-btn { width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; background: #34495e; color: white; font-weight: bold; font-size: 0.8rem; border-radius: 2px; cursor: pointer; border: none; transition: 0.2s;}
        .q-btn.answered { background: #2ecc71; }
        .q-btn.active { outline: 2px solid #f39c12; outline-offset: 2px; }

        /* Timer */
        .timer-display { background: black; color: red; font-family: monospace; font-size: 1.5rem; font-weight: bold; padding: 5px 15px; border-radius: 4px; display: inline-block; float: right; }

        /* Question Area */
        .question-meta { font-size: 0.85rem; color: #6c757d; text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        .question-text { font-size: 1.2rem; font-weight: 500; color: #333; margin-bottom: 25px; }
        
        /* Options */
        .option-row { display: flex; align-items: center; margin-bottom: 12px; cursor: pointer; }
        .option-letter { font-weight: bold; margin-right: 15px; font-size: 1.1rem; color: #555;}
        .option-radio { transform: scale(1.2); margin-right: 15px; cursor: pointer; }
        .option-text { font-size: 1.1rem; color: #444; }

        /* Bottom Controls */
        .controls { border-top: 1px solid #eee; padding-top: 20px; margin-top: 40px; display: flex; justify-content: space-between; }
        .btn-nav { background: #f8f9fa; border: 1px solid #ddd; font-weight: bold; color: #555; padding: 8px 20px;}
        .btn-nav:hover { background: #e2e6ea; }
        .btn-submit { background: #3498db; color: white; font-weight: bold; padding: 8px 30px; border: none;}
        
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f7fa; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <i class="fas fa-spinner fa-spin fa-3x text-success mb-3"></i>
        <h4 class="text-dark fw-bold">Authenticating & Loading Exam Data...</h4>
    </div>

    <div class="exam-header" style="display: none;" id="mainHeader">
        <div class="school-logo">
            <i class="fas fa-graduation-cap fa-2x text-warning me-2"></i> SPRINGDRILL
        </div>
        <div class="exam-info">
            Welcome <span id="hdrName">Student</span><br>
            Test Title: <span id="hdrTitle">Loading...</span><br>
            Test Duration: <span id="hdrDuration">0</span> minutes<br>
        </div>
    </div>

    <div class="main-container" style="display: none;" id="mainContainer">
        
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <div class="subject-badge" id="subjectBadge">General</div>
                <div class="q-grid" id="questionGrid">
                    </div>
            </div>
            <div class="timer-display" id="timerBox">00:00:00</div>
        </div>

        <div id="questionArea">
            <div class="question-meta" id="qMeta">QUESTION 1 OF --</div>
            <div class="question-text" id="qText">Loading question...</div>
            
            <div id="optionsArea">
                </div>
        </div>

        <div class="controls">
            <button class="btn btn-nav" id="btnPrev" onclick="navigate(-1)"><i class="fas fa-arrow-left me-2"></i> Previous</button>
            <button class="btn btn-submit" id="btnSubmitFinal" onclick="submitExam()" style="display: none;">Submit Final</button>
            <button class="btn btn-success fw-bold px-4" id="btnNext" onclick="navigate(1)">Next <i class="fas fa-arrow-right ms-2"></i></button>
        </div>
    </div>

    <script type="module">
        import { supabase } from './supabaseClient.js';

        let studentSession = null;
        let testId = null;
        let questions = [];
        let currentIdx = 0;
        let userAnswers = {}; 
        let timeRemaining = 0;
        let timerInterval;

        async function initializeExam() {
            try {
                // 1. Auth & Profile
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return window.location.href = 'login.html';
                studentSession = session;

                const { data: stuData } = await supabase.from('students').select('surname, first_name, users(name)').eq('user_id', session.user.id).single();
                const studentName = stuData ? (stuData.first_name ? `${stuData.first_name} ${stuData.surname}` : stuData.users.name) : 'Student';
                document.getElementById('hdrName').innerText = studentName;

                // 2. Validate Test ID
                const urlParams = new URLSearchParams(window.location.search);
                testId = urlParams.get('test_id') || urlParams.get('id');

                if (!testId) {
                    alert("No Exam Selected. Returning to dashboard.");
                    return window.location.href = 'student_cbt.html';
                }

                // Prevent Retakes
                const { data: pastAttempt } = await supabase.from('test_results').select('id').eq('student_id', session.user.id).eq('test_id', testId).single();
                if (pastAttempt) {
                    alert("You have already completed this exam.");
                    return window.location.href = 'student_cbt.html';
                }

                // 3. Fetch Test Config
                const { data: testData, error: tErr } = await supabase.from('tests').select('*, subjects(name)').eq('id', testId).single();
                if (tErr) throw new Error("Test details not found.");

                document.getElementById('hdrTitle').innerText = testData.title;
                document.getElementById('subjectBadge').innerText = testData.subjects?.name || 'Assessment';
                const duration = testData.duration_minutes || testData.duration || 30;
                document.getElementById('hdrDuration').innerText = duration;

                // 4. THE BULLETPROOF TWO-STEP QUESTION FETCH
                
                // Step A: Get exactly which question IDs belong to this test
                const { data: mappingData, error: mapErr } = await supabase.from('test_questions').select('question_id').eq('test_id', testId);
                if (mapErr || !mappingData || mappingData.length === 0) throw new Error("No questions available for this exam.");
                
                const questionIdsToFetch = mappingData.map(row => row.question_id);

                // Step B: Grab the physical questions matching those IDs
                const { data: finalQs, error: qErr } = await supabase.from('questions').select('*').in('id', questionIdsToFetch);
                if (qErr || !finalQs || finalQs.length === 0) throw new Error("Failed to load question text from database.");

                questions = finalQs;

                // Build the Grid
                buildNavigationGrid();

                // Start Timer
                timeRemaining = duration * 60;
                startTimer();

                // Reveal UI
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('mainHeader').style.display = 'flex';
                document.getElementById('mainContainer').style.display = 'block';
                
                renderQuestion();

            } catch (err) {
                console.error(err);
                alert(err.message);
                window.location.href = 'student_cbt.html';
            }
        }

        function buildNavigationGrid() {
            const grid = document.getElementById('questionGrid');
            grid.innerHTML = questions.map((_, idx) => `
                <div class="q-btn" id="navBtn_${idx}" onclick="jumpTo(${idx})">${idx + 1}</div>
            `).join('');
        }

        function updateGridColors() {
            questions.forEach((q, idx) => {
                const btn = document.getElementById(`navBtn_${idx}`);
                if (userAnswers[q.id]) {
                    btn.classList.add('answered');
                }
                if (idx === currentIdx) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        window.renderQuestion = () => {
            const q = questions[currentIdx];
            document.getElementById('qMeta').innerText = `QUESTION ${currentIdx + 1} OF ${questions.length}`;
            document.getElementById('qText').innerText = q.question_text || q.question;

            const savedAns = userAnswers[q.id];

            const optionsHtml = ['A', 'B', 'C', 'D'].map(letter => {
                const optValue = q[`option_${letter.toLowerCase()}`]; 
                if (!optValue) return ''; 
                
                const isChecked = savedAns === letter ? 'checked' : '';
                
                return `
                    <label class="option-row">
                        <input type="radio" name="currentQ" class="option-radio" value="${letter}" ${isChecked} onchange="saveAnswer('${q.id}', this.value)">
                        <span class="option-letter">${letter}</span>
                        <span class="option-text">${optValue}</span>
                    </label>
                `;
            }).join('');

            document.getElementById('optionsArea').innerHTML = optionsHtml;

            // Handle Buttons
            document.getElementById('btnPrev').disabled = currentIdx === 0;
            
            if (currentIdx === questions.length - 1) {
                document.getElementById('btnNext').style.display = 'none';
                document.getElementById('btnSubmitFinal').style.display = 'block';
            } else {
                document.getElementById('btnNext').style.display = 'block';
                document.getElementById('btnSubmitFinal').style.display = 'none';
            }

            updateGridColors();
        };

        window.saveAnswer = (qId, val) => {
            userAnswers[qId] = val;
            updateGridColors();
        };

        window.navigate = (dir) => {
            currentIdx += dir;
            renderQuestion();
        };

        window.jumpTo = (idx) => {
            currentIdx = idx;
            renderQuestion();
        };

        function startTimer() {
            const display = document.getElementById('timerBox');
            timerInterval = setInterval(() => {
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    display.innerText = "00:00:00";
                    alert("Time is up! Submitting automatically.");
                    submitExam();
                    return;
                }
                timeRemaining--;
                
                const h = Math.floor(timeRemaining / 3600).toString().padStart(2, '0');
                const m = Math.floor((timeRemaining % 3600) / 60).toString().padStart(2, '0');
                const s = (timeRemaining % 60).toString().padStart(2, '0');
                display.innerText = `${h}:${m}:${s}`;
            }, 1000);
        }

        window.submitExam = async () => {
            if (!confirm("Are you sure you want to submit your final answers?")) return;
            
            clearInterval(timerInterval);
            const btn = document.getElementById('btnSubmitFinal');
            btn.innerText = 'Submitting...';
            btn.disabled = true;

            try {
                let score = 0;
                questions.forEach(q => {
                    if (userAnswers[q.id] === q.correct_option) score++;
                });

                const { error } = await supabase.from('test_results').insert([{
                    student_id: studentSession.user.id,
                    test_id: testId,
                    score: score,
                    total_questions: questions.length
                }]);

                if (error) throw error;

                alert(`Exam Submitted! You scored ${score} out of ${questions.length}.`);
                window.location.href = 'student_cbt.html';

            } catch (err) {
                console.error(err);
                alert("Error submitting: " + err.message);
                btn.innerText = 'Submit Final';
                btn.disabled = false;
                startTimer(); // Resume if failed
            }
        };

        document.addEventListener('DOMContentLoaded', initializeExam);
    </script>
</body>
</html>