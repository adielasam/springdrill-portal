<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPRINGDRILL - Student Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-x: hidden; }
        
        /* Sidebar Styling */
        .sidebar { width: 280px; position: fixed; top: 0; left: 0; height: 100vh; background: linear-gradient(180deg, #1a3c34 0%, #122b25 100%); color: white; padding-top: 30px; z-index: 1000; box-shadow: 4px 0 15px rgba(0,0,0,0.1); }
        .sidebar-brand { text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .sidebar-brand i { color: #f1c40f; font-size: 2.5rem; margin-bottom: 10px; }
        .nav-link { color: rgba(255,255,255,0.8); padding: 15px 25px; margin: 4px 15px; border-radius: 8px; transition: all 0.3s; display: flex; align-items: center; text-decoration: none; font-weight: 500;}
        .nav-link i { width: 25px; font-size: 1.1rem; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.15); color: white; transform: translateX(5px); }

        /* Main Content */
        .main-content { margin-left: 280px; padding: 40px; min-height: 100vh; }
        .top-header { background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #2ecc71; }
        
        /* Cards */
        .exam-card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #e9ecef; transition: transform 0.2s; margin-bottom: 20px;}
        .exam-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.06); border-color: #1a3c34;}
        .exam-title { font-size: 1.2rem; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .exam-meta { font-size: 0.9rem; color: #6c757d; margin-bottom: 15px; }
        .exam-meta i { width: 20px; color: #1a3c34; }

        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <i class="fas fa-spinner fa-spin fa-3x text-success mb-3"></i>
        <h4>Loading your Portal...</h4>
    </div>

    <div class="sidebar">
        <div class="sidebar-brand">
            <i class="fas fa-graduation-cap"></i>
            <h4 class="text-white fw-bold mb-0">STUDENT</h4>
        </div>
        
        <nav class="nav flex-column mt-4">
            <a href="student_dashboard.html" class="nav-link active"><i class="fas fa-home"></i> My Dashboard</a>
            <a href="take_test.html" class="nav-link"><i class="fas fa-laptop-code"></i> Active Exams</a>
            <a href="student_results.html" class="nav-link"><i class="fas fa-chart-line"></i> My Results</a>
            <hr class="mx-3 my-4 border-secondary">
            <a href="#" id="logoutBtn" class="nav-link text-danger mt-auto"><i class="fas fa-sign-out-alt"></i> Secure Logout</a>
        </nav>
    </div>

    <div class="main-content">
        <div class="top-header">
            <div>
                <h3 class="fw-bold mb-0 text-dark" id="welcomeText">Welcome back!</h3>
                <p class="text-muted mb-0 mt-1">Class: <strong id="studentClass" class="text-success">Loading...</strong></p>
            </div>
            <div id="profileImageContainer">
                </div>
        </div>

        <h5 class="fw-bold mb-4 text-dark"><i class="fas fa-clipboard-list text-warning me-2"></i> Your Assigned Exams</h5>
        
        <div class="row" id="examsGrid">
            </div>

    </div>

    <script type="module">
        import { supabase } from './supabaseClient.js';

        async function initializeDashboard() {
            try {
                // 1. Verify Student
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return window.location.href = 'login.html';

                // 2. Fetch Student Profile safely (bypassing .single() errors)
                const { data: studentRecords, error: stuErr } = await supabase
                    .from('students')
                    .select('surname, first_name, class_id, passport_url, classes(name), users(name)')
                    .eq('user_id', session.user.id);

                if (stuErr) throw stuErr;

                if (!studentRecords || studentRecords.length === 0) {
                     document.getElementById('welcomeText').innerText = "Profile Incomplete";
                     document.getElementById('studentClass').innerText = "N/A";
                     document.getElementById('examsGrid').innerHTML = `<div class="col-12"><div class="alert alert-danger fw-bold"><i class="fas fa-exclamation-triangle me-2"></i> Your student profile is incomplete in the database. Please contact the Admin.</div></div>`;
                     document.getElementById('loadingOverlay').style.display = 'none';
                     return;
                }

                // Grab the first matched record safely
                const student = studentRecords[0];

                // Display Welcome Info
                const displayName = student.first_name ? `${student.first_name} ${student.surname || ''}` : student.users?.name;
                document.getElementById('welcomeText').innerText = `Welcome, ${displayName || 'Student'}!`;
                document.getElementById('studentClass').innerText = student.classes?.name || 'Unassigned';

                if (student.passport_url) {
                    document.getElementById('profileImageContainer').innerHTML = `<img src="${student.passport_url}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #2ecc71;">`;
                }

                // 3. Fetch Exams JUST for this Student's Class
                if (!student.class_id) {
                    document.getElementById('examsGrid').innerHTML = `<div class="col-12"><div class="alert alert-warning fw-bold"><i class="fas fa-exclamation-triangle me-2"></i> You have not been assigned to a class yet. Please contact the Admin.</div></div>`;
                    document.getElementById('loadingOverlay').style.display = 'none';
                    return;
                }

                const { data: tests, error: testErr } = await supabase
                    .from('tests')
                    .select('*')
                    .eq('class_id', student.class_id)
                    .order('created_at', { ascending: false });

                if (testErr) throw testErr;

                // 4. Check if they already took the test
                const { data: pastAttempts } = await supabase
                    .from('test_results')
                    .select('test_id, score')
                    .eq('student_id', session.user.id);
                
                const takenTestIds = pastAttempts ? pastAttempts.map(a => a.test_id) : [];

                // 5. Render the Grid
                const grid = document.getElementById('examsGrid');
                
                if (!tests || tests.length === 0) {
                    grid.innerHTML = `<div class="col-12"><div class="exam-card text-center py-5 text-muted"><i class="fas fa-mug-hot fa-3x mb-3 opacity-50"></i><h5>No exams available right now.</h5><p class="small">When your teacher publishes a test for your class, it will appear here.</p></div></div>`;
                } else {
                    grid.innerHTML = tests.map(test => {
                        const hasTaken = takenTestIds.includes(test.id);
                        
                        let buttonHtml = '';
                        if (hasTaken) {
                            const result = pastAttempts.find(a => a.test_id === test.id);
                            buttonHtml = `<button class="btn btn-outline-success w-100 fw-bold" disabled><i class="fas fa-check-circle me-1"></i> Completed (Score: ${result.score})</button>`;
                        } else {
                            buttonHtml = `<a href="take_test.html?id=${test.id}" class="btn btn-dark w-100 fw-bold"><i class="fas fa-play me-2"></i> Start Exam</a>`;
                        }

                        return `
                            <div class="col-md-6 col-lg-4">
                                <div class="exam-card">
                                    <div class="exam-title">${test.title || 'CBT Assessment'}</div>
                                    <div class="exam-meta">
                                        <div><i class="fas fa-clock"></i> ${test.duration || 30} Minutes</div>
                                        <div class="mt-1"><i class="fas fa-calendar-alt"></i> Added recently</div>
                                    </div>
                                    ${buttonHtml}
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                document.getElementById('loadingOverlay').style.display = 'none';
            } catch (err) {
                console.error(err);
                alert("Error loading dashboard: " + err.message);
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', initializeDashboard);

        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        });
    </script>
</body>
</html>