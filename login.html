<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPRINGDRILL - Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Preserving your exact original CSS */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, rgba(0,0,0,0.7), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1517694712202-14dd9538aa97'); background-size: cover; background-position: center; min-height: 100vh; display: flex; align-items: center; justify-content: center; position: relative; }
        .floating-squares { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 1; }
        .square { position: absolute; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); animation: float 6s ease-in-out infinite; }
        .square:nth-child(1) { width: 80px; height: 80px; top: 10%; left: 10%; animation-delay: 0s; }
        .square:nth-child(2) { width: 60px; height: 60px; top: 20%; right: 15%; animation-delay: 2s; }
        .square:nth-child(3) { width: 100px; height: 100px; bottom: 20%; left: 15%; animation-delay: 4s; }
        .square:nth-child(4) { width: 70px; height: 70px; bottom: 30%; right: 20%; animation-delay: 1s; }
        .square:nth-child(5) { width: 90px; height: 90px; top: 50%; left: 5%; animation-delay: 3s; }
        .square:nth-child(6) { width: 50px; height: 50px; top: 70%; right: 10%; animation-delay: 5s; }
        @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; } 50% { transform: translateY(-20px) rotate(180deg); opacity: 1; } }
        .login-container { position: relative; z-index: 2; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); padding: 3rem; width: 100%; max-width: 450px; border: 1px solid rgba(255, 255, 255, 0.2); animation: fadeInUp 0.8s ease forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .brand-logo { text-align: center; margin-bottom: 2rem; }
        .brand-logo h1 { color: #2c3e50; font-weight: 700; font-size: 2.5rem; margin-bottom: 0.5rem; }
        .brand-logo p { color: #7f8c8d; font-size: 1rem; margin: 0; }
        .form-floating { margin-bottom: 1.5rem; position: relative; }
        .form-floating .form-control { border: 2px solid #e9ecef; border-radius: 12px; height: 60px; font-size: 1rem; transition: all 0.3s ease; }
        .form-floating .form-control:focus { border-color: #3498db; box-shadow: 0 0 20px rgba(52, 152, 219, 0.2); }
        .btn-login { background: linear-gradient(135deg, #3498db, #2980b9); border: none; border-radius: 12px; height: 55px; font-size: 1.1rem; font-weight: 600; color: white; width: 100%; transition: all 0.3s ease; }
        .btn-login:hover { background: linear-gradient(135deg, #2980b9, #1f4e79); transform: translateY(-2px); }
        .signup-link { text-align: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e9ecef; }
        .signup-link a { color: #3498db; text-decoration: none; font-weight: 600; }
        .toggle-password { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #7f8c8d; cursor: pointer; z-index: 3; }
        .alert { display: none; border-radius: 12px; border: none; margin-bottom: 1.5rem; font-weight: 500; }
    </style>
</head>
<body>
    <div class="floating-squares">
        <div class="square"></div><div class="square"></div><div class="square"></div>
        <div class="square"></div><div class="square"></div><div class="square"></div>
    </div>

    <div class="login-container">
        <div class="brand-logo">
            <h1><i class="fas fa-graduation-cap"></i> SPRINGDRILL</h1>
            <p>Welcome back! Please sign in to your account</p>
        </div>

        <div id="errorAlert" class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i><span id="errorMsg"></span>
        </div>

        <form id="loginForm">
            <div class="form-floating">
                <input type="email" id="email" class="form-control" placeholder="Email Address" required>
                <label for="email"><i class="fas fa-envelope me-2"></i>Email Address</label>
            </div>

            <div class="form-floating password-container">
                <input type="password" id="password" class="form-control" placeholder="Password" required>
                <label for="password"><i class="fas fa-lock me-2"></i>Password</label>
                <button type="button" class="toggle-password" onclick="togglePassword()">
                    <i class="fas fa-eye" id="toggleIcon"></i>
                </button>
            </div>

            <button type="submit" class="btn btn-login" id="loginBtn">
                <i class="fas fa-sign-in-alt me-2"></i>Sign In
            </button>
        </form>

        <div class="signup-link">
            <p>Don't have an account? <a href="signup.html">Sign up here</a></p>
        </div>
    </div>

    <script type="module">
        import { supabase } from './supabaseClient.js';

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('loginBtn');
            const alertBox = document.getElementById('errorAlert');
            const errorMsg = document.getElementById('errorMsg');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Authenticating...';
            alertBox.style.display = 'none';

            try {
                // 1. Authenticate with Supabase
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({ email, password });
                if (authError) throw authError;

                // 2. Fetch User Profile & Role from public.users table
                const { data: profile, error: profileError } = await supabase
                    .from('users')
                    .select('role, name')
                    .eq('id', authData.user.id)
                    .single();

                if (profileError || !profile) throw new Error("Profile not found in database.");

                // 3. Routing & Approval Checks
                if (profile.role === 'admin') {
                    window.location.href = 'admin_dashboard.html';
                } 
                else if (profile.role === 'teacher') {
                    const { data: teacher } = await supabase.from('teachers').select('approved').eq('user_id', authData.user.id).single();
                    if (teacher && teacher.approved) {
                        window.location.href = 'teacher_dashboard.html';
                    } else {
                        await supabase.auth.signOut();
                        throw new Error("Your teacher account is pending admin approval.");
                    }
                } 
                else if (profile.role === 'student') {
                    const { data: student } = await supabase.from('students').select('approved').eq('user_id', authData.user.id).single();
                    if (student && student.approved) {
                        window.location.href = 'student_dashboard.html';
                    } else {
                        await supabase.auth.signOut();
                        throw new Error("Your student account is pending admin approval.");
                    }
                }

            } catch (err) {
                errorMsg.textContent = err.message;
                alertBox.style.display = 'block';
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>Sign In';
            }
        });

        // Toggle Password Visibility attached to window for inline onclick
        window.togglePassword = function() {
            const pwd = document.getElementById('password');
            const icon = document.getElementById('toggleIcon');
            if (pwd.type === 'password') {
                pwd.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                pwd.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        };
    </script>
</body>
</html>