<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPRING DRILL - Class List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .content { margin-left: 250px; padding: 20px; }
        .header { background-color: #1a3c34; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .pending { background-color: #fff3cd; }
        .section-title { margin-top: 30px; margin-bottom: 10px; }
        .action-buttons { white-space: nowrap; }
        .edit-form { display: none; }
        .edit-form.active { display: block; }
        .student-row.editing .student-name { display: none; }
        .export-btn { margin-bottom: 15px; }
        
        /* Mobile adjustment for sidebar absence in this snippet */
        @media (max-width: 768px) {
            .content { margin-left: 0; }
        }
    </style>
</head>
<body>
    <div class="content">
        <div class="header">
            <h2>Class List</h2>
            <p class="mb-0">View and manage students by class.</p>
        </div>

        <div id="alertBox" class="alert d-none"></div>

        <div class="row mb-3">
            <div class="col-md-4">
                <label for="class_id" class="form-label">Class</label>
                <select id="class_id" class="form-select" required>
                    <option value="">Select Class</option>
                    </select>
            </div>
        </div>

        <div class="export-btn d-none" id="exportContainer">
            <button id="exportBtn" class="btn btn-success">
                <i class="fas fa-download"></i> Export Approved Students
            </button>
        </div>

        <h4 class="section-title">Approved Class List</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Class Name</th>
                    <th width="200">Actions</th>
                </tr>
            </thead>
            <tbody id="approvedStudentsBody">
                <tr><td colspan="3" class="text-center text-muted">Select a class to view students.</td></tr>
            </tbody>
        </table>

        <h4 class="section-title">Pending Approval</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Class Name</th>
                    <th width="200">Action</th>
                </tr>
            </thead>
            <tbody id="pendingStudentsBody">
                <tr><td colspan="3" class="text-center text-muted">Select a class to view pending students.</td></tr>
            </tbody>
        </table>

        <div class="mt-4">
            <a href="teacher_dashboard.html" class="btn btn-secondary">Back to Dashboard</a>
        </div>
    </div>

    <script type="module">
        import { supabase } from './supabaseClient.js';

        const alertBox = document.getElementById('alertBox');
        const classSelect = document.getElementById('class_id');
        const exportContainer = document.getElementById('exportContainer');
        
        let currentClassId = null;
        let currentClassName = '';
        let approvedStudentsData = []; // Store for CSV export

        function showAlert(msg, type = 'success') {
            alertBox.className = `alert alert-${type} d-block`;
            alertBox.textContent = msg;
            setTimeout(() => { alertBox.className = 'alert d-none'; }, 4000);
        }

        async function init() {
            // 1. Authenticate & Verify Teacher Role
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) { window.location.href = 'login.html'; return; }

            const { data: userData } = await supabase
                .from('users')
                .select('role')
                .eq('id', user.id)
                .single();

            if (!userData || userData.role !== 'teacher') {
                window.location.href = 'login.html'; // Or restricted page
                return;
            }

            // 2. Load Classes Dropdown
            const { data: classes, error } = await supabase.from('classes').select('*').order('name');
            if (classes) {
                classSelect.innerHTML = `<option value="">Select Class</option>` + 
                    classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }
        }

        async function loadStudents(classId) {
            if (!classId) return;
            currentClassId = classId;
            currentClassName = classSelect.options[classSelect.selectedIndex].text;

            try {
                // Fetch Students with nested User data
                const { data: students, error } = await supabase
                    .from('students')
                    .select(`
                        id, approved, user_id,
                        users (id, name)
                    `)
                    .eq('class_id', classId)
                    .order('users(name)');

                if (error) throw error;

                const approved = students.filter(s => s.approved === true);
                const pending = students.filter(s => s.approved === false);
                
                approvedStudentsData = approved; // Save for CSV

                renderApproved(approved);
                renderPending(pending);

                if (approved.length > 0) {
                    exportContainer.classList.remove('d-none');
                } else {
                    exportContainer.classList.add('d-none');
                }

            } catch (err) {
                showAlert('Failed to load students: ' + err.message, 'danger');
            }
        }

        function renderApproved(students) {
            const tbody = document.getElementById('approvedStudentsBody');
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No approved students found.</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(student => `
                <tr class="student-row" id="row-${student.user_id}">
                    <td>
                        <span class="student-name" id="name-${student.user_id}">${student.users.name}</span>
                        <div class="edit-form input-group" id="edit-form-${student.user_id}">
                            <input type="text" id="input-${student.user_id}" class="form-control" value="${student.users.name}">
                            <button onclick="window.saveStudentName('${student.user_id}')" class="btn btn-success btn-sm"><i class="fas fa-check"></i></button>
                            <button onclick="window.cancelEdit('${student.user_id}')" class="btn btn-secondary btn-sm"><i class="fas fa-times"></i></button>
                        </div>
                    </td>
                    <td>${currentClassName}</td>
                    <td class="action-buttons">
                        <button onclick="window.editStudent('${student.user_id}')" class="btn btn-primary btn-sm">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button onclick="window.deleteStudent('${student.id}', true)" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderPending(students) {
            const tbody = document.getElementById('pendingStudentsBody');
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No pending approvals.</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(student => `
                <tr class="pending">
                    <td>${student.users.name}</td>
                    <td>${currentClassName}</td>
                    <td>
                        <button onclick="window.approveStudent('${student.id}')" class="btn btn-success btn-sm"><i class="fas fa-check"></i> Approve</button>
                        <button onclick="window.deleteStudent('${student.id}', false)" class="btn btn-danger btn-sm"><i class="fas fa-times"></i> Reject</button>
                    </td>
                </tr>
            `).join('');
        }

        // --- GLOBAL ACTIONS FOR INLINE HTML CALLS ---
        window.editStudent = (userId) => {
            document.getElementById(`row-${userId}`).classList.add('editing');
            document.getElementById(`edit-form-${userId}`).classList.add('active');
        };

        window.cancelEdit = (userId) => {
            document.getElementById(`row-${userId}`).classList.remove('editing');
            document.getElementById(`edit-form-${userId}`).classList.remove('active');
            document.getElementById(`input-${userId}`).value = document.getElementById(`name-${userId}`).innerText;
        };

        window.saveStudentName = async (userId) => {
            const newName = document.getElementById(`input-${userId}`).value.trim();
            if (!newName) return;

            try {
                // Update the user's name in the 'users' table
                const { error } = await supabase.from('users').update({ name: newName }).eq('id', userId);
                if (error) throw error;
                
                showAlert('Student name updated successfully.');
                loadStudents(currentClassId); // Reload UI
            } catch (err) {
                showAlert('Error updating name: ' + err.message, 'danger');
            }
        };

        window.approveStudent = async (studentId) => {
            try {
                const { error } = await supabase.from('students').update({ approved: true }).eq('id', studentId);
                if (error) throw error;
                showAlert('Student approved successfully.');
                loadStudents(currentClassId);
            } catch (err) {
                showAlert('Error approving student.', 'danger');
            }
        };

        window.deleteStudent = async (studentId, isApproved) => {
            const msg = isApproved ? 'Are you sure you want to remove this student from the class?' : 'Are you sure you want to reject this student?';
            if (!confirm(msg)) return;

            try {
                const { error } = await supabase.from('students').delete().eq('id', studentId);
                if (error) throw error;
                showAlert(`Student ${isApproved ? 'removed' : 'rejected'} successfully.`);
                loadStudents(currentClassId);
            } catch (err) {
                showAlert('Error removing student.', 'danger');
            }
        };

        // --- EVENT LISTENERS ---
        classSelect.addEventListener('change', (e) => loadStudents(e.target.value));

        document.getElementById('exportBtn').addEventListener('click', () => {
            if (approvedStudentsData.length === 0) return;

            // Generate CSV completely in the browser
            let csvContent = "Student Name,Class Name\n";
            approvedStudentsData.forEach(student => {
                // Escape commas in names by wrapping in quotes
                const safeName = `"${student.users.name.replace(/"/g, '""')}"`;
                csvContent += `${safeName},"${currentClassName}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", `${currentClassName.replace(/\s+/g, '_')}_students.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Start
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>