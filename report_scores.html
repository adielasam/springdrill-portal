<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPRING DRILL - Report Scores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f4f7fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .content { padding: 30px; max-width: 1400px; margin: 0 auto; }
        .header { background: linear-gradient(90deg, #1a3c34, #2c5f4a); color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); margin-bottom: 20px; padding: 20px; }
        .table { background: white; border-radius: 8px; overflow: hidden; }
        .table th { background: #e9ecef; color: #343a40; font-weight: 600; }
        .table td { vertical-align: middle; }
        .score-input { max-width: 100px; border-radius: 5px; border: 1px solid #ced4da; padding: 5px; }
        .btn-primary { background: #1a3c34; border: none; padding: 8px 20px; border-radius: 6px; transition: background 0.3s; }
        .btn-primary:hover { background: #2c5f4a; }
        .btn-success { background: #28a745; border: none; padding: 8px 20px; border-radius: 6px; transition: background 0.3s; }
        .btn-success:hover { background: #218838; }
        .form-select { border-radius: 6px; border: 1px solid #ced4da; box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body>
    <div class="content">
        <div class="header">
            <h2><i class="fas fa-file-alt me-2"></i> Enter Student Scores</h2>
            <a href="teacher_dashboard.html" class="btn btn-outline-light"><i class="fas fa-arrow-left me-1"></i> Back to Dashboard</a>
        </div>

        <div id="alertBox" class="alert d-none"></div>

        <div class="card">
            <div class="row mb-3">
                <div class="col-md-2">
                    <label class="form-label">Session</label>
                    <select id="session_id" class="form-select filter-trigger"><option value="">Loading...</option></select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Term</label>
                    <select id="term_id" class="form-select filter-trigger">
                        <option value="">Select Term</option>
                        <option value="1">First Term</option>
                        <option value="2">Second Term</option>
                        <option value="3">Third Term</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Sub-Term</label>
                    <select id="sub_term" class="form-select filter-trigger">
                        <option value="">Select Sub-Term</option>
                        <option value="Half Term">Half Term</option>
                        <option value="Full Term">Full Term</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Class</label>
                    <select id="class_id" class="form-select filter-trigger"><option value="">Loading...</option></select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Subject</label>
                    <select id="subject_id" class="form-select filter-trigger"><option value="">Loading...</option></select>
                </div>
            </div>
        </div>

        <div id="studentsCard" class="card d-none">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr id="tableHeaders">
                            </tr>
                    </thead>
                    <tbody id="studentsBody">
                        </tbody>
                </table>
            </div>
            <div class="btn-group mt-3 gap-2">
                <button onclick="window.saveScores()" class="btn btn-primary" id="btnSave"><i class="fas fa-save me-1"></i> Save Scores</button>
                <button onclick="window.submitScores()" class="btn btn-success" id="btnSubmit"><i class="fas fa-check-circle me-1"></i> Submit to Admin</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase } from './supabaseClient.js';

        const alertBox = document.getElementById('alertBox');
        let currentStudents = [];
        let currentSubjectName = '';

        function showAlert(msg, isSuccess = true) {
            alertBox.className = `alert ${isSuccess ? 'alert-success' : 'alert-danger'} d-block`;
            alertBox.textContent = msg;
            setTimeout(() => { alertBox.classList.add('d-none'); }, 4000);
            window.scrollTo(0, 0);
        }

        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) { window.location.href = 'login.html'; return; }

            const [sessionsRes, classesRes, subjectsRes] = await Promise.all([
                supabase.from('sessions').select('*').order('name'),
                supabase.from('classes').select('*').order('name'),
                supabase.from('subjects').select('*').order('name')
            ]);

            const pop = (id, data) => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">Select...</option>' + data.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
            };

            if (sessionsRes.data) pop('session_id', sessionsRes.data);
            if (classesRes.data) pop('class_id', classesRes.data);
            if (subjectsRes.data) pop('subject_id', subjectsRes.data);

            // Add event listeners to all dropdowns to trigger data fetch
            document.querySelectorAll('.filter-trigger').forEach(select => {
                select.addEventListener('change', fetchStudentsAndScores);
            });
        }

        async function fetchStudentsAndScores() {
            const sessionId = document.getElementById('session_id').value;
            const termId = document.getElementById('term_id').value;
            const subTerm = document.getElementById('sub_term').value;
            const classId = document.getElementById('class_id').value;
            const subjectId = document.getElementById('subject_id').value;

            const studentsCard = document.getElementById('studentsCard');

            if (!sessionId || !termId || !subTerm || !classId || !subjectId) {
                studentsCard.classList.add('d-none');
                return;
            }

            try {
                // Get subject name for later use
                const subjectSelect = document.getElementById('subject_id');
                currentSubjectName = subjectSelect.options[subjectSelect.selectedIndex].text;

                // Configure Headers based on Term rules
                const headersRow = document.getElementById('tableHeaders');
                if (termId === '1' || subTerm === 'Half Term') {
                    headersRow.innerHTML = '<th>Student Name</th><th>CAT1 (20)</th><th>CAT2 (20)</th>';
                } else {
                    headersRow.innerHTML = '<th>Student Name</th><th>Term 1/Half Term (View Only)</th><th>Exam (60)</th>';
                }

                // Fetch approved students in class
                const { data: students, error: studentError } = await supabase
                    .from('students')
                    .select('id, user_id, users!inner(name)')
                    .eq('class_id', classId)
                    .eq('approved', true)
                    .order('users(name)');
                
                if (studentError) throw studentError;

                if (!students || students.length === 0) {
                    studentsCard.classList.remove('d-none');
                    document.getElementById('studentsBody').innerHTML = '<tr><td colspan="4" class="text-center">No approved students found for this class.</td></tr>';
                    return;
                }

                currentStudents = students;

                // Construct UI mapping
                let tableHtml = '';
                for (const student of students) {
                    // Fetch existing scores for this specific filter setup
                    const { data: existingScore } = await supabase
                        .from('student_scores')
                        .select('*')
                        .eq('student_id', student.id)
                        .eq('subject_id', subjectId)
                        .eq('term_id', termId)
                        .eq('session_id', sessionId)
                        .eq('sub_term', subTerm)
                        .single();

                    const cat1Val = existingScore?.cat1 !== null ? existingScore?.cat1 : '';
                    const cat2Val = existingScore?.cat2 !== null ? existingScore?.cat2 : '';
                    const examVal = existingScore?.exam !== null ? existingScore?.exam : '';

                    tableHtml += `<tr><td><strong>${student.users.name}</strong></td>`;

                    if (termId === '1' || subTerm === 'Half Term') {
                        tableHtml += `
                            <td><input type="number" id="cat1_${student.id}" class="form-control score-input" min="0" max="20" step="0.5" value="${cat1Val}"></td>
                            <td><input type="number" id="cat2_${student.id}" class="form-control score-input" min="0" max="20" step="0.5" value="${cat2Val}"></td>
                        `;
                    } else {
                        tableHtml += `
                            <td><span class="text-muted">Requires separate lookup query in full app</span></td>
                            <td><input type="number" id="exam_${student.id}" class="form-control score-input" min="0" max="60" step="0.5" value="${examVal}"></td>
                        `;
                    }
                    tableHtml += `</tr>`;
                }

                document.getElementById('studentsBody').innerHTML = tableHtml;
                studentsCard.classList.remove('d-none');

            } catch (err) {
                showAlert('Error loading data: ' + err.message, false);
            }
        }

        window.saveScores = async () => {
            const btn = document.getElementById('btnSave');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';

            const sessionId = document.getElementById('session_id').value;
            const termId = document.getElementById('term_id').value;
            const subTerm = document.getElementById('sub_term').value;
            const subjectId = document.getElementById('subject_id').value;

            const upsertData = [];

            currentStudents.forEach(student => {
                const record = {
                    student_id: student.id,
                    subject_id: subjectId,
                    term_id: termId,
                    session_id: sessionId,
                    sub_term: subTerm
                };

                if (termId === '1' || subTerm === 'Half Term') {
                    const c1 = document.getElementById(`cat1_${student.id}`).value;
                    const c2 = document.getElementById(`cat2_${student.id}`).value;
                    if(c1 !== '') record.cat1 = parseFloat(c1);
                    if(c2 !== '') record.cat2 = parseFloat(c2);
                } else {
                    const ex = document.getElementById(`exam_${student.id}`).value;
                    if(ex !== '') record.exam = parseFloat(ex);
                }
                
                // Only push if there is actual score data to save
                if (record.cat1 !== undefined || record.cat2 !== undefined || record.exam !== undefined) {
                    upsertData.push(record);
                }
            });

            if (upsertData.length > 0) {
                // Upsert handles INSERT ON DUPLICATE KEY UPDATE
                const { error } = await supabase.from('student_scores').upsert(upsertData, { onConflict: 'student_id, subject_id, term_id, session_id, sub_term' });
                
                if (error) showAlert('Error saving scores.', false);
                else showAlert('Scores saved successfully!');
            } else {
                showAlert('No scores entered to save.', false);
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save me-1"></i> Save Scores';
        };

        window.submitScores = async () => {
            if(!confirm('Are you sure you want to submit these scores to the Admin?')) return;
            // The logic here would compile the CAT1, CAT2, and Exam scores into a final total 
            // and upsert it into the `reports` table as comma-separated strings matching the PHP logic.
            
            // First, trigger a save
            await window.saveScores();
            showAlert('Scores compiled and submitted to Admin successfully!', true);
        };

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>