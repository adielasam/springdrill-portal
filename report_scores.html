<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPRINGDRILL - Report Scores & Heatmap</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f7fa; overflow-x: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Sidebar Styling */
        .sidebar { width: 280px; position: fixed; top: 0; left: 0; height: 100vh; background: linear-gradient(180deg, #1a3c34 0%, #122b25 100%); color: white; padding-top: 30px; z-index: 1000; box-shadow: 4px 0 15px rgba(0,0,0,0.1); }
        .sidebar-brand { text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .sidebar-brand i { color: #3498db; font-size: 2.5rem; margin-bottom: 10px; }
        .nav-link { color: rgba(255,255,255,0.8); padding: 15px 25px; margin: 4px 15px; border-radius: 8px; transition: all 0.3s; display: flex; align-items: center; text-decoration: none; }
        .nav-link i { width: 25px; font-size: 1.1rem; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.15); color: white; transform: translateX(5px); }
        .nav-link.text-danger:hover { background: rgba(220, 53, 69, 0.2); color: #ff6b6b !important; }

        /* Main Content Styling */
        .main-content { margin-left: 280px; padding: 40px; min-height: 100vh; }
        .top-header { background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #0dcaf0; }

        /* Content Cards */
        .content-card { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: none; margin-bottom: 30px; }
        
        /* Heatmap Table Styling */
        .table-heatmap th { background-color: #2c3e50; color: white; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; border: 1px solid #34495e; text-align: center; vertical-align: middle; }
        .table-heatmap td { text-align: center; vertical-align: middle; font-weight: bold; border: 1px solid #dee2e6; transition: transform 0.2s; }
        .table-heatmap td:hover { transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 10; position: relative; }
        .student-name-cell { text-align: left !important; background-color: #f8f9fa; color: #2c3e50; font-weight: 600; }
        
        /* Heatmap Colors */
        .hm-excellent { background-color: #2ecc71 !important; color: white !important; } /* 75-100 */
        .hm-good { background-color: #82e0aa !important; color: #155724 !important; } /* 60-74 */
        .hm-average { background-color: #f1c40f !important; color: #856404 !important; } /* 50-59 */
        .hm-poor { background-color: #e74c3c !important; color: white !important; } /* 0-49 */
        .hm-na { background-color: #f8f9fa !important; color: #adb5bd !important; font-weight: normal; } /* No Data */

        /* Loading Overlay */
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <i class="fas fa-spinner fa-spin fa-3x text-info mb-3"></i>
        <h4 id="loadingText">Authenticating Staff Credentials...</h4>
    </div>

    <div class="sidebar">
        <div class="sidebar-brand">
            <i class="fas fa-chalkboard-teacher"></i>
            <h4 class="text-white fw-bold mb-0">STAFF PORTAL</h4>
        </div>
        
        <nav class="nav flex-column mt-4">
            <a href="teacher_dashboard.html" class="nav-link">
                <i class="fas fa-home"></i> Dashboard Home
            </a>
            <a href="create_test.html" class="nav-link">
                <i class="fas fa-plus-circle"></i> Create New Test
            </a>
            <a href="manage_cbt.html" class="nav-link">
                <i class="fas fa-tasks"></i> Manage CBT
            </a>
            <a href="test_results.html" class="nav-link">
                <i class="fas fa-poll"></i> Student Results
            </a>
            <a href="report_scores.html" class="nav-link active">
                <i class="fas fa-file-signature"></i> Report Scores
            </a>
            
            <hr class="mx-3 my-4 border-secondary">
            
            <a href="#" id="logoutBtn" class="nav-link text-danger mt-auto">
                <i class="fas fa-sign-out-alt"></i> Secure Logout
            </a>
        </nav>
    </div>

    <div class="main-content">
        <div class="top-header">
            <div>
                <h3 class="fw-bold mb-0 text-dark"><i class="fas fa-th text-info me-2"></i> Gradebook Heatmap</h3>
                <p class="text-muted mb-0 mt-1">Comprehensive overview of all exams taken per subject.</p>
            </div>
            
            <div class="w-25">
                <label class="form-label mb-1 fw-bold text-info">Select Class to Analyze:</label>
                <select id="classSelect" class="form-select border-info shadow-sm fw-bold text-dark">
                    <option value="">Loading classes...</option>
                </select>
            </div>
        </div>

        <div id="reportDashboard" style="display: none;">
            
            <div class="content-card mb-4">
                <h5 class="fw-bold mb-4 border-bottom pb-2"><i class="fas fa-chart-bar text-primary me-2"></i> Class Performance Average by Subject</h5>
                <div style="position: relative; height:30vh; width:100%">
                    <canvas id="subjectPerformanceChart"></canvas>
                </div>
            </div>

            <div class="content-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold m-0"><i class="fas fa-table text-success me-2"></i> Master Gradebook & Heatmap</h5>
                    <div class="d-flex gap-2 text-muted small fw-bold">
                        <span class="badge hm-excellent text-white">75-100%</span>
                        <span class="badge hm-good text-dark">60-74%</span>
                        <span class="badge hm-average text-dark">50-59%</span>
                        <span class="badge hm-poor text-white">< 50%</span>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-heatmap table-bordered" id="heatmapTable">
                        <thead id="heatmapThead">
                            </thead>
                        <tbody id="heatmapTbody">
                            </tbody>
                    </table>
                </div>
                
                <div class="d-flex justify-content-end mt-4">
                    <button class="btn btn-outline-dark fw-bold" onclick="exportHeatmapCSV()">
                        <i class="fas fa-file-csv me-2"></i> Export Master Sheet to CSV
                    </button>
                </div>
            </div>
        </div>
        
        <div id="emptyState" class="text-center py-5 mt-5">
            <i class="fas fa-shapes fa-4x text-muted opacity-25 mb-3"></i>
            <h4 class="text-muted fw-bold">Select a Class</h4>
            <p class="text-muted">Choose a class from the dropdown above to generate the Master Gradebook.</p>
        </div>
    </div>

    <script type="module">
        import { supabase } from './supabaseClient.js';

        let currentUserId = null;
        let chartInstance = null;
        let exportDataMatrix = []; // Used for CSV export
        let exportHeaders = [];

        // 1. Initialize Page & Load Classes
        async function initializePage() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }
                currentUserId = session.user.id;

                // Load available classes
                const { data: classes, error } = await supabase.from('classes').select('id, name').order('id', { ascending: true });
                const classSelect = document.getElementById('classSelect');
                
                if (error) throw error;

                if (classes && classes.length > 0) {
                    classSelect.innerHTML = `<option value="" disabled selected>-- Select Target Class --</option>` + 
                        classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                } else {
                    classSelect.innerHTML = `<option value="">No classes found in database.</option>`;
                }

                document.getElementById('loadingOverlay').style.display = 'none';
            } catch (err) {
                console.error("Initialization Error:", err);
                alert("Failed to authenticate.");
            }
        }

        document.addEventListener('DOMContentLoaded', initializePage);

        // 2. Fetch and Build the Heatmap when Class is selected
        document.getElementById('classSelect').addEventListener('change', async (e) => {
            const classId = e.target.value;
            if (!classId) return;

            document.getElementById('emptyState').style.display = 'none';
            const dashboard = document.getElementById('reportDashboard');
            dashboard.style.display = 'none'; // Hide while rendering
            
            const overlay = document.getElementById('loadingOverlay');
            document.getElementById('loadingText').innerText = "Aggregating student exam data... This may take a moment.";
            overlay.style.display = 'flex';

            try {
                // A) Fetch all approved students in this class
                const { data: students, error: sErr } = await supabase
                    .from('students')
                    .select('user_id, users(name)')
                    .eq('class_id', classId)
                    .eq('approved', true);
                if (sErr) throw sErr;

                // B) Fetch all subjects to use as columns
                const { data: subjects, error: subErr } = await supabase
                    .from('subjects')
                    .select('id, name')
                    .order('name', { ascending: true });
                if (subErr) throw subErr;

                // C) Fetch ALL test attempts for this class
                // We join test_attempts with tests to filter by class_id and get the subject_id
                const { data: attempts, error: aErr } = await supabase
                    .from('test_attempts')
                    .select(`
                        student_id,
                        percentage,
                        tests!inner(subject_id, class_id)
                    `)
                    .eq('tests.class_id', classId)
                    .not('end_time', 'is', null);
                if (aErr) throw aErr;

                if (students.length === 0) {
                    alert("There are no approved students in this class yet.");
                    overlay.style.display = 'none';
                    return;
                }

                // 3. Process Data Matrix (Student -> Subject -> Scores Array)
                const matrix = {};
                // Initialize matrix with students
                students.forEach(student => {
                    matrix[student.user_id] = {
                        name: student.users.name,
                        subjects: {}
                    };
                    subjects.forEach(sub => {
                        matrix[student.user_id].subjects[sub.id] = [];
                    });
                });

                // Populate with actual attempt percentages
                attempts.forEach(attempt => {
                    const stuId = attempt.student_id;
                    const subId = attempt.tests.subject_id;
                    if (matrix[stuId] && matrix[stuId].subjects[subId]) {
                        matrix[stuId].subjects[subId].push(parseFloat(attempt.percentage));
                    }
                });

                // Filter out subjects that have ZERO data across all students to keep the table clean
                const activeSubjectIds = subjects.filter(sub => {
                    return attempts.some(a => a.tests.subject_id === sub.id);
                }).map(sub => sub.id);

                const activeSubjects = subjects.filter(sub => activeSubjectIds.includes(sub.id));

                if (activeSubjects.length === 0) {
                    alert("No exam data exists for this class yet. Students must complete tests first.");
                    overlay.style.display = 'none';
                    return;
                }

                buildHeatmapUI(matrix, students, activeSubjects);
                buildChartUI(matrix, students, activeSubjects);

                dashboard.style.display = 'block';
                overlay.style.display = 'none';

            } catch (err) {
                console.error(err);
                alert("Error compiling report data.");
                overlay.style.display = 'none';
            }
        });

        // 4. Construct the HTML Table Data
        function buildHeatmapUI(matrix, students, activeSubjects) {
            const thead = document.getElementById('heatmapThead');
            const tbody = document.getElementById('heatmapTbody');
            
            exportDataMatrix = []; // Reset for CSV
            exportHeaders = ['Student Name', ...activeSubjects.map(s => s.name), 'Overall Average'];

            // Build Header Row
            let headerHTML = `<tr><th style="text-align: left;">Student Name</th>`;
            activeSubjects.forEach(sub => {
                headerHTML += `<th>${sub.name}</th>`;
            });
            headerHTML += `<th>Overall Avg</th></tr>`;
            thead.innerHTML = headerHTML;

            // Build Body Rows
            let bodyHTML = '';
            
            // Sort students alphabetically
            students.sort((a, b) => a.users.name.localeCompare(b.users.name));

            students.forEach(student => {
                const stuData = matrix[student.user_id];
                let rowHTML = `<tr><td class="student-name-cell">${stuData.name}</td>`;
                
                let studentTotalScore = 0;
                let studentSubjectsCount = 0;
                let csvRow = [stuData.name];

                activeSubjects.forEach(sub => {
                    const scoresArray = stuData.subjects[sub.id];
                    let cellClass = 'hm-na';
                    let cellText = 'N/A';
                    let csvValue = 'N/A';

                    if (scoresArray.length > 0) {
                        // Calculate average for this specific subject if they took multiple tests in it
                        const sum = scoresArray.reduce((a, b) => a + b, 0);
                        const avg = sum / scoresArray.length;
                        
                        studentTotalScore += avg;
                        studentSubjectsCount++;
                        
                        cellText = `${avg.toFixed(1)}%`;
                        csvValue = avg.toFixed(1);

                        // Heatmap Color Logic
                        if (avg >= 75) cellClass = 'hm-excellent';
                        else if (avg >= 60) cellClass = 'hm-good';
                        else if (avg >= 50) cellClass = 'hm-average';
                        else cellClass = 'hm-poor';
                    }

                    rowHTML += `<td class="${cellClass}">${cellText}</td>`;
                    csvRow.push(csvValue);
                });

                // Overall Average Column
                let overallAvg = studentSubjectsCount > 0 ? (studentTotalScore / studentSubjectsCount).toFixed(1) : 0;
                let overallClass = 'hm-na';
                if (studentSubjectsCount > 0) {
                    if (overallAvg >= 75) overallClass = 'hm-excellent';
                    else if (overallAvg >= 60) overallClass = 'hm-good';
                    else if (overallAvg >= 50) overallClass = 'hm-average';
                    else overallClass = 'hm-poor';
                }
                
                rowHTML += `<td class="${overallClass}" style="border-left: 3px solid #34495e;">${studentSubjectsCount > 0 ? overallAvg + '%' : 'N/A'}</td></tr>`;
                csvRow.push(studentSubjectsCount > 0 ? overallAvg : 'N/A');
                exportDataMatrix.push(csvRow);

                bodyHTML += rowHTML;
            });

            tbody.innerHTML = bodyHTML;
        }

        // 5. Build Chart.js Graph (Subject Averages)
        function buildChartUI(matrix, students, activeSubjects) {
            const subjectLabels = [];
            const subjectAverages = [];
            const backgroundColors = [];

            activeSubjects.forEach(sub => {
                subjectLabels.push(sub.name);
                
                let totalSubScore = 0;
                let subStudentCount = 0;

                students.forEach(student => {
                    const scoresArray = matrix[student.user_id].subjects[sub.id];
                    if (scoresArray.length > 0) {
                        const sum = scoresArray.reduce((a, b) => a + b, 0);
                        totalSubScore += (sum / scoresArray.length);
                        subStudentCount++;
                    }
                });

                const avg = subStudentCount > 0 ? (totalSubScore / subStudentCount) : 0;
                subjectAverages.push(avg.toFixed(1));

                // Color chart bars based on same heatmap logic
                if (avg >= 75) backgroundColors.push('rgba(46, 204, 113, 0.8)');
                else if (avg >= 60) backgroundColors.push('rgba(130, 224, 170, 0.8)');
                else if (avg >= 50) backgroundColors.push('rgba(241, 196, 15, 0.8)');
                else backgroundColors.push('rgba(231, 76, 60, 0.8)');
            });

            const ctx = document.getElementById('subjectPerformanceChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy(); // Clear old chart if rendering new class
            }

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: subjectLabels,
                    datasets: [{
                        label: 'Class Average %',
                        data: subjectAverages,
                        backgroundColor: backgroundColors,
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Percentage Score' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // 6. CSV Export Logic
        window.exportHeatmapCSV = () => {
            if (exportDataMatrix.length === 0) {
                alert("No data available to export.");
                return;
            }

            const classSelect = document.getElementById('classSelect');
            const className = classSelect.options[classSelect.selectedIndex].text.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Add Headers
            csvContent += exportHeaders.map(h => `"${h}"`).join(',') + "\n";

            // Add Rows
            exportDataMatrix.forEach(rowArray => {
                let row = rowArray.map(val => `"${val}"`).join(',');
                csvContent += row + "\n";
            });

            // Trigger Download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Master_Gradebook_${className}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        });
    </script>
</body>
</html>