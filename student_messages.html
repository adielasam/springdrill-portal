<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPRINGDRILL - My Inbox</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-x: hidden; }
        
        .sidebar { width: 260px; position: fixed; top: 0; left: 0; height: 100vh; background: #004d34; color: white; padding-top: 20px; z-index: 1000; }
        .sidebar-brand { text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px; }
        .nav-link { color: rgba(255,255,255,0.8); padding: 12px 20px; margin: 2px 10px; border-radius: 5px; transition: all 0.3s; font-size: 0.95rem; }
        .nav-link i { width: 25px; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.15); color: white; font-weight: bold; border-left: 4px solid #f1c40f;}

        .main-content { margin-left: 260px; padding: 20px 40px; min-height: 100vh; }
        .page-header-card { background: white; border-radius: 8px; border-left: 5px solid #007a4d; padding: 20px 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); margin-bottom: 30px; }
        
        .edu-card { background: white; border: 1px solid #dee2e6; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); margin-bottom: 30px; }
        .edu-header { background-color: #2c3e50; color: white; padding: 15px 20px; border-radius: 4px 4px 0 0; font-weight: bold; display: flex; justify-content: space-between; align-items: center;}
        
        /* Message Row Styles */
        .msg-row { cursor: pointer; transition: 0.2s; }
        .msg-row:hover { background-color: #f8f9fa; }
        .msg-unread { font-weight: 800; background-color: #f1f8ff; border-left: 4px solid #0d6efd;}
        .msg-read { color: #6c757d; border-left: 4px solid transparent;}
        
        .modal-body-mail { padding: 30px; white-space: pre-wrap; font-size: 1.05rem; line-height: 1.6; color: #333;}

        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loadingOverlay"><i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i><h4 class="fw-bold text-muted">Checking Inbox...</h4></div>

    <div class="sidebar">
        <div class="sidebar-brand">
            <h5 class="text-white fw-bold"><i class="fas fa-graduation-cap text-warning me-2"></i> STUDENT PORTAL</h5>
        </div>
        <nav class="nav flex-column mt-3">
            <a href="student_dashboard.html" class="nav-link"><i class="fas fa-home"></i> Dashboard</a>
            <a href="student_eclassroom.html" class="nav-link"><i class="fas fa-play"></i> eClassroom</a>
            <a href="student_cbt.html" class="nav-link"><i class="fas fa-laptop-code"></i> CBT / Exams</a>
            <a href="student_results.html" class="nav-link"><i class="fas fa-award"></i> Result Manager</a>
            
            <a href="student_messages.html" class="nav-link active mt-2"><i class="fas fa-envelope"></i> My Inbox <span class="badge bg-danger ms-auto" id="navUnreadCount" style="display: none;">0</span></a>
            
            <hr class="mx-3 my-4 border-secondary">
            <a href="#" id="logoutBtn" class="nav-link text-warning mt-auto"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </nav>
    </div>

    <div class="main-content">
        <div class="page-header-card d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-1"><i class="fas fa-envelope-open-text text-primary me-2"></i> Official Mailbox</h4>
                <p class="text-muted mb-0">Secure communication from School Administration.</p>
            </div>
            <div class="text-end">
                <h3 class="fw-bold text-dark mb-0" id="topUnreadCount">0</h3>
                <small class="text-muted fw-bold text-uppercase">Unread Messages</small>
            </div>
        </div>

        <div class="edu-card">
            <div class="edu-header">
                <span><i class="fas fa-inbox me-2"></i> Inbox</span>
            </div>
            <div class="table-responsive p-0">
                <table class="table mb-0">
                    <tbody id="inboxBody">
                        <tr><td class="text-center py-5">Loading your mail...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="readMessageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content shadow-lg border-0">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title fw-bold" id="modalSubject">Subject</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between border-bottom pb-3 mb-3">
                        <div>
                            <small class="text-muted fw-bold d-block">FROM:</small>
                            <span class="fw-bold text-success" id="modalSender">Admin</span>
                        </div>
                        <div class="text-end">
                            <small class="text-muted fw-bold d-block">DATE:</small>
                            <span class="fw-bold" id="modalDate">Date</span>
                        </div>
                    </div>
                    <div class="modal-body-mail" id="modalBodyText">
                        Loading content...
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary fw-bold px-4" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { supabase } from './supabaseClient.js';
        
        let currentUserId = null;
        let mailModal = null;
        let allMessages = [];

        async function initInbox() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return window.location.href = 'login.html';
                currentUserId = session.user.id;
                
                mailModal = new bootstrap.Modal(document.getElementById('readMessageModal'));

                await fetchMessages();
                document.getElementById('loadingOverlay').style.display = 'none';
            } catch (err) { console.error(err); }
        }

        async function fetchMessages() {
            try {
                const { data: msgs } = await supabase.from('messages').select('*').eq('receiver_id', currentUserId).order('created_at', { ascending: false });
                
                const tbody = document.getElementById('inboxBody');
                if (!msgs || msgs.length === 0) return tbody.innerHTML = `<tr><td class="text-center py-5 text-muted"><i class="fas fa-envelope-open fa-3x mb-3 opacity-25"></i><br>Your inbox is empty.</td></tr>`;

                allMessages = msgs; // Store globally for modal access

                // Fetch Senders Manually
                const senderIds = [...new Set(msgs.map(m => m.sender_id))];
                const { data: users } = await supabase.from('users').select('id, name, role').in('id', senderIds);
                const userMap = {};
                if (users) users.forEach(u => userMap[u.id] = { name: u.name, role: u.role });

                let unreadCount = 0;

                tbody.innerHTML = msgs.map((m, index) => {
                    if (!m.is_read) unreadCount++;
                    const rowClass = m.is_read ? 'msg-read' : 'msg-unread';
                    const sender = userMap[m.sender_id] ? `${userMap[m.sender_id].name} (${userMap[m.sender_id].role.toUpperCase()})` : 'System Admin';
                    const dateStr = new Date(m.created_at).toLocaleDateString('en-US', {month: 'short', day: 'numeric'});

                    return `
                        <tr class="msg-row ${rowClass} border-bottom" onclick="window.openMessage(${index})">
                            <td width="20%" class="ps-4">${sender}</td>
                            <td width="60%"><strong>${m.subject}</strong> <span class="text-muted ms-2 fw-normal">- ${m.body.substring(0, 40)}...</span></td>
                            <td width="20%" class="text-end pe-4 text-muted small">${dateStr}</td>
                        </tr>
                    `;
                }).join('');

                // Update Notification Badges
                document.getElementById('topUnreadCount').innerText = unreadCount;
                const navBadge = document.getElementById('navUnreadCount');
                if (unreadCount > 0) {
                    navBadge.innerText = unreadCount;
                    navBadge.style.display = 'inline-block';
                } else {
                    navBadge.style.display = 'none';
                }

            } catch (err) { console.error(err); }
        }

        window.openMessage = async function(index) {
            const m = allMessages[index];
            
            document.getElementById('modalSubject').innerText = m.subject;
            document.getElementById('modalBodyText').innerText = m.body;
            document.getElementById('modalDate').innerText = new Date(m.created_at).toLocaleString();
            
            // Mark as read in Database if unread
            if (!m.is_read) {
                await supabase.from('messages').update({ is_read: true }).eq('id', m.id);
                m.is_read = true;
                await fetchMessages(); // Refresh UI in background
            }
            
            mailModal.show();
        };

        document.addEventListener('DOMContentLoaded', initInbox);
        document.getElementById('logoutBtn').addEventListener('click', async (e) => { e.preventDefault(); await supabase.auth.signOut(); window.location.href = 'login.html'; });
    </script>
</body>
</html>